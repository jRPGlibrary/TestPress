<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test du Compteur de Visiteurs</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .counter-container {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .debug-panel {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .debug-panel h3 {
            margin-top: 0;
        }
        .debug-log {
            font-family: monospace;
            white-space: pre-wrap;
            margin: 5px 0;
        }
        .error {
            color: red;
        }
        .warning {
            color: orange;
        }
        .info {
            color: blue;
        }
        button {
            padding: 8px 12px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Test du Compteur de Visiteurs</h1>
    
    <div class="counter-container">
        <h2>Compteur de visiteurs: <span id="visitor-counter">0</span></h2>
    </div>
    
    <div>
        <button id="test-gtm">Tester l'initialisation GTM</button>
        <button id="test-events">Tester les événements</button>
        <button id="test-response">Simuler une réponse</button>
        <button id="clear-logs">Effacer les logs</button>
    </div>
    
    <div class="debug-panel">
        <h3>Console de débogage</h3>
        <div id="debug-logs"></div>
    </div>

    <script>
        // Fonction pour ajouter des logs à la console de débogage
        function debugLog(message, type = 'info') {
            const logElement = document.createElement('div');
            logElement.className = `debug-log ${type}`;
            logElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('debug-logs').appendChild(logElement);
            console.log(message);
        }

        // Rediriger les logs de console vers notre panneau de débogage
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(message) {
            debugLog(typeof message === 'object' ? JSON.stringify(message) : message, 'info');
            originalConsoleLog.apply(console, arguments);
        };

        console.error = function(message) {
            debugLog(typeof message === 'object' ? JSON.stringify(message) : message, 'error');
            originalConsoleError.apply(console, arguments);
        };

        console.warn = function(message) {
            debugLog(typeof message === 'object' ? JSON.stringify(message) : message, 'warning');
            originalConsoleWarn.apply(console, arguments);
        };

        // Initialiser dataLayer
        window.dataLayer = window.dataLayer || [];

        // Simuler l'événement DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOMContentLoaded déclenché');
        });

        // Bouton pour tester l'initialisation GTM
        document.getElementById('test-gtm').addEventListener('click', function() {
            debugLog('Test d\'initialisation GTM');
            try {
                // Vérifier si les fonctions nécessaires existent
                if (typeof initGTMVisitorCounter === 'function') {
                    debugLog('Fonction initGTMVisitorCounter trouvée, exécution...');
                    initGTMVisitorCounter();
                } else {
                    console.error('Fonction initGTMVisitorCounter non trouvée!');
                }
            } catch (error) {
                console.error('Erreur lors de l\'initialisation GTM: ' + error.message);
            }
        });

        // Bouton pour tester les événements
        document.getElementById('test-events').addEventListener('click', function() {
            debugLog('Test des événements');
            try {
                // Simuler l'envoi d'événements
                dataLayer.push({
                    'event': 'get_visitor_count',
                    'gtm.uniqueEventId': new Date().getTime()
                });
                debugLog('Événement get_visitor_count envoyé');
                
                // Vérifier si l'écouteur d'événements est configuré
                debugLog('Vérification de l\'écouteur d\'événements...');
                const listeners = window._messageListeners || [];
                debugLog(`Nombre d'écouteurs d'événements message: ${listeners.length || 'inconnu'}`);
            } catch (error) {
                console.error('Erreur lors du test des événements: ' + error.message);
            }
        });

        // Bouton pour simuler une réponse
        document.getElementById('test-response').addEventListener('click', function() {
            debugLog('Simulation d\'une réponse');
            try {
                // Simuler une réponse de GTM
                const visitorCount = Math.floor(Math.random() * 100) + 1;
                window.postMessage({
                    'event': 'visitor_count_response',
                    'visitorCount': visitorCount.toString()
                }, '*');
                debugLog(`Réponse simulée avec visitorCount=${visitorCount}`);
                
                // Simuler également l'autre format de réponse
                window.postMessage({
                    'event': 'visitor_count_data',
                    'visitorCount': (visitorCount + 10).toString()
                }, '*');
                debugLog(`Réponse alternative simulée avec visitorCount=${visitorCount + 10}`);
            } catch (error) {
                console.error('Erreur lors de la simulation de réponse: ' + error.message);
            }
        });

        // Bouton pour effacer les logs
        document.getElementById('clear-logs').addEventListener('click', function() {
            document.getElementById('debug-logs').innerHTML = '';
            debugLog('Logs effacés');
        });

        // Charger les scripts à tester
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Charger les scripts nécessaires
        Promise.all([
            loadScript('google-analytics.js'),
            loadScript('gtm-visitor-counter.js')
        ]).then(() => {
            debugLog('Scripts chargés avec succès');
        }).catch(error => {
            console.error('Erreur lors du chargement des scripts: ' + error);
        });

        // Initialiser
        debugLog('Page de test initialisée');
    </script>
</body>
</html>